# AGENTS.md

Repository guidance for coding agents and contributors.

## Scope

- Apply these rules to the whole repository.
- Main implementation targets:
  - `expense_cli.py`
  - `scripts/generate_workbooks.py`
  - documentation files in repo root

## Development conventions

- Python 3.11+.
- Keep dependencies minimal.
- Prefer standard library unless a package is necessary.
- Preserve Portuguese business terms used by the user domain (`Assinaturas`, `Parcelados`, `Orçamento`, `Transações`).

## Operational guardrails

- API server lifecycle:
  - The API is typically started without `--reload` (`scripts/app_endpoint.py` / `tracking_despesas_server.py`).
  - After backend changes in `api.py`, restart API and verify live schema via `/openapi.json` before concluding.
- Frontend syntax checks:
  - Do not run `py_compile` against `.jsx` files; validate frontend with `npm --prefix dashboard run build`.
- Mobile screenshots:
  - Prefer Playwright viewport captures (`--viewport-size`) over device emulation.
  - Device emulation may fail on hosts missing Playwright system dependencies.
- Desktop screenshot validation:
  - Capture at least one desktop viewport screenshot (for example `1440x900`) for UI changes.
  - Validate action-bar alignment, overflow/clipping, and card/grid spacing before concluding.
- Dirty worktree discipline:
  - Stage and commit only files related to the requested scope.
  - Never include unrelated local changes in the same commit.

## CLI changes

- Any new feature in `expense_cli.py` must include:
  - command wiring in argparse
  - persistent storage updates (SQLite schema/migrations-safe behavior)
  - at least one report/list path to validate outcomes
- Keep commands idempotent where possible (example: monthly subscription materialization).
- Budget model is account-wide (not month-specific):
  - Do not reintroduce `budget_month` in API/CLI payloads or SQL.
  - Keep migration-safe behavior for legacy DBs that still have `budget_month`.

## API/UI alignment rules

- Keep API helpers and automation scripts aligned with backend contracts:
  - When `/api` payloads change, update `.agents/skills/tracking-api-actions/` scripts and references in the same change.
- Curation flows:
  - Always propagate selected `file` through all curation API calls (`meta`, `transactions`, `update`, `export`, `import-expenses`).
  - Keep curation updates persistence semantics: edit writes back to CSV immediately (temp file + replace).
- Subscription materialization:
  - Materialization is explicit and idempotent per month (CLI `run-subscriptions` and API/UI run action should match this behavior).

## Excel/workbook changes

- Robust workbook structure is generated by `scripts/generate_workbooks.py`.
- If workbook schema changes, update:
  - generator script
  - `WORKBOOK_DESIGN.md`
  - `README.md` usage snippets if commands/outputs change

## Validation checklist

- Run:
  - `make test-cli`
- For workbook changes, run:
  - `make gen-workbook`
- For quick end-to-end confidence, run:
  - `make smoke`
- Prefer lightweight smoke tests over heavy frameworks unless requested.

## Non-goals unless requested

- No deployment/infrastructure changes.
- No frontend/UI work.
- No destructive resets or reverting unrelated user changes.
